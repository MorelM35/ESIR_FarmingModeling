import exploitation.impl.ExploitationFactoryImpl
import fr.inria.diverse.k3.al.annotationprocessor.Aspect
import static extension ExploitationAspect.*
import static extension SurfaceAspect.*
import static extension ParcelleAspect.*
import static extension RessourceAspect.*
import static extension RessourceAllocationAspect.*
import static extension RessourceTypeAspect.*
import static extension PeriodicActivityAspect.*
import static extension RuleAspect.*
import static extension AtelierAspect.*
import static extension AtelierRefAspect.*
import exploitation.*
import activity.*
import fr.inria.diverse.k3.al.annotationprocessor.OverrideAspectMethod
import org.eclipse.emf.common.util.EList

/************************************************************
 * 							EXPLOITATION
 ************************************************************/
@Aspect(className=Exploitation) 
class ExploitationAspect {

	def simulate(int qtyWater, java.util.Date begin, java.util.Date end) {
	}

	def void compile() {
		val dump = '''---Exploitation «_self.name»---
		«FOR s : _self.surface»
		«s.compile()»
		«ENDFOR»
		---Ressources---
		«FOR s : _self.ressource»
		«s.compile()»
		«ENDFOR»
		'''
		println(dump)
	}

}

@Aspect(className=Surface)
class SurfaceAspect {

	def simulate() {
	}

	def compile() {
		'''---Surface---
		---Parcelles---
		«FOR p : _self.parcelle»
		«p.compile()»
		«ENDFOR»
		--Atelier--
		«_self.atelier.compile»
		'''
	}

}

@Aspect(className=Parcelle)
class ParcelleAspect {

	def simulate() {
	}

	def compile() {
		'''ID :«_self.id», surface :«_self.hectar»Ha, «IF _self.irrigue»irrigué«ELSE»"NON irrigué"«ENDIF»'''
		
	}
		
}


@Aspect(className=Date)
class DateAspect {

	def simulate() {
	}

	def compile() {
		'''«_self.day»/«_self.month»/«_self.year»'''
	}	
}

/************************************************************
 * 							ACTIVITY
 ************************************************************/

@Aspect(className=Model)
class ModelAspect {
	
	def getAtelierList(){
		val list = <String,EList<PeriodicActivity>>newHashMap()
		for(a:_self.atelier){
			list.put(a.id,a.activity)
		}
		return list
	}

	def simulate() {
	}

	def compile() {
		'''Modèle 
		«FOR a : _self.atelier»
		«a.compile()»
		«ENDFOR»
		'''
	}	
}

@Aspect(className=AtelierRef)
class AtelierRefAspect {

	def getActivitieList(){
		return _self.activity
	}
	
	def simulate() {
	}

	def compile() {
		'''Modèle 
		«FOR a : _self.activity»
		«a.compile()»
		«ENDFOR»
		'''
	}	
}


@Aspect(className=PeriodicActivity)
class PeriodicActivityAspect {

	def simulate() {
	}

	def compile() {
		'''
		---«_self.name»---
		start : «_self.start.day»/«_self.start.month»/«_self.start.year» | end : «_self.end.day»/«_self.end.month»/«_self.end.year»
		every «_self.frequency»
		allocate : 
		
		rules :
		«FOR r : _self.rule»
		«r.compile»
		«ENDFOR»
		'''
	}	
}

/************************************************************
 * 							RESSOURCES
 ************************************************************/
@Aspect(className=Ressource)
class RessourceAspect {

	def simulate() {
	}

	def compile() {
		'''«_self.name»(«_self.type.compile()») :
		«FOR ra : _self.resAllocation»
		«ra.compile()»
		«ENDFOR»
		'''		
	}	
}

@Aspect(className=RessourceType)
class RessourceTypeAspect {

	def simulate() {
	}

	def compile() {
		'''«_self.name»'''
	}	
}

@Aspect(className=RessourceAllocation)
class RessourceAllocationAspect {

	def simulate() {
	}

	def compile() {
		'''«_self.ressourceType» during:«_self.duration» «_self.periodicityType»'''
	}	
}

/************************************************************
 * 							RULES
 ************************************************************/
@Aspect(className=Rule)
abstract class RuleAspect {
	def String compile();
}
@Aspect(className=Predicat)
class PredicatAspect extends RuleAspect {

	def simulate() {
	}
	
	@OverrideAspectMethod
	def String compile() {
		'''date :«DateAspect.compile(_self.date)»'''
	}	
}

@Aspect(className=NoRain)
class NoRainAspect extends PredicatAspect{

	def simulate() {
	}

    @OverrideAspectMethod
	def String compile() {
		'''Pas de pluie pendant «_self.elapsedTime» «_self.periodicityType»'''
	}	
}


@Aspect(className=EvapoTranspiration)
class EvapoTranspirationAspect extends PredicatAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''«_self.value»'''
	}	
}

@Aspect(className=GrainState)
class GrainStateAspect extends PredicatAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''état de maturation du grain :«_self.state»'''
	}	
}

@Aspect(className=BinaryExpression)
class BinaryExpressionAspect extends RuleAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''(«_self.left.compile()» «_self.ope» «_self.right.compile()»)'''
	}
}

/************************************************************
 * 							WEATHER
 ************************************************************/

@Aspect(className=Rayonnement)
class RayonnementAspect extends WeatherAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''rayonnement :«_self.value» lux'''
	}	
}


@Aspect(className=Precipitation)
class PrecipitationAspect extends WeatherAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''«_self.height» millimètre d'eau'''
	}	
}


@Aspect(className=Temperature)
class TemperatureAspect extends WeatherAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''«_self.value» °C'''
	}	
}


@Aspect(className=Weather)
abstract class WeatherAspect extends PredicatAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile();
}

/************************************************************
 * 							ATELIERS
 ************************************************************/
@Aspect(className=Atelier)
abstract class AtelierAspect {
	def String compile() ;
}
 
 @Aspect(className=Ble)
class BleAspect extends CultureAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		''' > BLE 
		«FOR act : _self.activity»
		«act.compile()»
		«ENDFOR»
		'''
	}	
}

@Aspect(className=Bovin)
class BovinAspect extends ElevageAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''bovin'''
	}	
}

@Aspect(className=Culture)
abstract class CultureAspect extends AtelierAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''culture'''
	}	
}

@Aspect(className=Elevage)
abstract class ElevageAspect extends AtelierAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''elevage'''
	}	
}

@Aspect(className=Mais)
class MaisAspect extends CultureAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''mais'''
	}	
}

@Aspect(className=Ovin)
class OvinAspect extends ElevageAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''ovin'''
	}	
}

@Aspect(className=Sorgho)
class SorghoAspect extends CultureAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''sorgho'''
	}	
}