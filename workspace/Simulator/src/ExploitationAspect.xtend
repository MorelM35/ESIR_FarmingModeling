import exploitation.impl.ExploitationFactoryImpl
import fr.inria.diverse.k3.al.annotationprocessor.Aspect
import static extension ExploitationAspect.*
import static extension SurfaceAspect.*
import static extension ParcelleAspect.*
import static extension RessourceAspect.*
import static extension RessourceAllocationAspect.*
import static extension RessourceTypeAspect.*
import static extension PeriodicActivityAspect.*
import static extension RuleAspect.*
import static extension AtelierAspect.*
import static extension AtelierRefAspect.*
import exploitation.*
import activity.*
import fr.inria.diverse.k3.al.annotationprocessor.OverrideAspectMethod
import java.io.PrintWriter
import org.eclipse.emf.common.util.EList

/************************************************************
 * 							EXPLOITATION
 ************************************************************/
@Aspect(className=Exploitation) 
class ExploitationAspect {

	def simulate(int qtyWater, java.util.Date begin, java.util.Date end) {
	}

	def void compile() {
		var out = new PrintWriter("compile.html");
		val dump = '''
		<!DOCTYPE HTML>
		<html>
			<head>
				<title>Farming Modeling</title>
				<meta http-equiv="content-type" content="text/html; charset=utf-8" />
			</head>
			<body>			
			<h1>Exploitation <i>«_self.name»</i></h1>
			<ol>
				«FOR s : _self.surface»
				<li>«s.compile()»</li>
				«ENDFOR»
			</ol>
			<h2>Ressources</h2>
			<ol>				
				«FOR s : _self.ressource»
				<li>«s.compile()»</li>
				«ENDFOR»
			</ol>
		</body>
		</html>
		'''
		out.println(dump)
		out.close()
	}

}

@Aspect(className=Surface)
class SurfaceAspect {

	def simulate() {
	}

	def compile() {
		'''
		<h3>Surface</h3>
		<h4>Parcelles</h4>
		<ol>
			«FOR p : _self.parcelle»
			<li>«p.compile()»</li>
			«ENDFOR»
		</ol>
		<h4>Atelier</h4>
		«_self.atelier.compile»
		'''
	}

}

@Aspect(className=Parcelle)
class ParcelleAspect {

	def simulate() {
	}

	def compile() {
		'''
		<ul>
			<li>ID : «_self.id»</li>
			<li>surface : «_self.hectar»</li>
			<li>surface : «_self.hectar»Ha</li>
			<li><strong>«IF _self.irrigue»irrigué«ELSE»NON irrigué«ENDIF»</strong></li>
		</ul>'''
	}
		
}


@Aspect(className=Date)
class DateAspect {

	def simulate() {
	}

	def compile() {
		'''<strong>«_self.day» «_self.month» «_self.year»</strong>'''
	}	
}

/************************************************************
 * 							ACTIVITY
 ************************************************************/

@Aspect(className=Model)
class ModelAspect {
	
	def getAtelierList(){
		val list = <String,EList<PeriodicActivity>>newHashMap()
		for(a:_self.atelier){
			list.put(a.id,a.activity)
		}
		return list
	}

	def simulate() {
	}

	def compile() {
		'''
		«FOR a : _self.atelier»
		«a.compile()»
		«ENDFOR»
		'''
	}	
}

@Aspect(className=AtelierRef)
class AtelierRefAspect {

	def getActivitieList(){
		return _self.activity
	}
	
	def simulate() {
	}

	def compile() {
		'''--Activities--
		«FOR a : _self.activity»
		<li>«a.compile()»</li>
		«ENDFOR»
		</ol>
		'''
	}	
}


@Aspect(className=PeriodicActivity)
class PeriodicActivityAspect {

	def simulate() {
	}

	def compile() {
		'''<i>«_self.name»</i>
		<ul>
			<li>from «DateAspect.compile(_self.start)» to «DateAspect.compile(_self.end)»</li>
			<li>every «_self.frequency» «_self.periodicityType»</li>
			<li>Rules :
				<ol>
				«FOR r : _self.rule»
				<li>«r.compile»</li>
				«ENDFOR»
				</ol>
			</li>
		</ul>'''
	}	
}

/************************************************************
 * 							RESSOURCES
 ************************************************************/
@Aspect(className=Ressource)
class RessourceAspect {

	def simulate() {
	}

	def compile() {
		'''<h4>«_self.name»(<i>«_self.type.compile()»</i>)</h4>
		<ol>
		«FOR ra : _self.resAllocation»
		<li>«ra.compile()»</li>
		«ENDFOR»
		</ol>
		'''		
	}	
}

@Aspect(className=RessourceType)
class RessourceTypeAspect {

	def simulate() {
	}

	def compile() {
		'''«_self.name»'''
	}	
}

@Aspect(className=RessourceAllocation)
class RessourceAllocationAspect {

	def simulate() {
	}

	def compile() {
		'''«_self.ressourceType» during : «_self.duration» «_self.periodicityType»'''
	}	
}

/************************************************************
 * 							RULES
 ************************************************************/
@Aspect(className=Rule)
abstract class RuleAspect {
	def String compile();
}
@Aspect(className=Predicat)
class PredicatAspect extends RuleAspect {

	def simulate() {
	}
	
	@OverrideAspectMethod
	def String compile() {
		'''date : «DateAspect.compile(_self.date)»'''
	}	
}

@Aspect(className=NoRain)
class NoRainAspect extends PredicatAspect{

	def simulate() {
	}

    @OverrideAspectMethod
	def String compile() {
		'''Pas de pluie pendant «_self.elapsedTime» «_self.periodicityType»'''
	}	
}


@Aspect(className=EvapoTranspiration)
class EvapoTranspirationAspect extends PredicatAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''«_self.value»'''
	}	
}

@Aspect(className=GrainState)
class GrainStateAspect extends PredicatAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''état de maturation du grain : «_self.state»'''
	}	
}

@Aspect(className=BinaryExpression)
class BinaryExpressionAspect extends RuleAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''(«_self.left.compile()» «_self.ope» «_self.right.compile()»)'''
	}
}

/************************************************************
 * 							WEATHER
 ************************************************************/

@Aspect(className=Rayonnement)
class RayonnementAspect extends WeatherAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''rayonnement : «_self.value» lux'''
	}	
}


@Aspect(className=Precipitation)
class PrecipitationAspect extends WeatherAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''«_self.height» millimètre d'eau'''
	}	
}


@Aspect(className=Temperature)
class TemperatureAspect extends WeatherAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''«_self.value» °C'''
	}	
}


@Aspect(className=Weather)
abstract class WeatherAspect extends PredicatAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile();
}

/************************************************************
 * 							ATELIERS
 ************************************************************/
@Aspect(className=Atelier)
abstract class AtelierAspect {
	def String compile(){
		''' <i>«_self.id»</i></h4>
		<h5>Activités périodique</h5>
		<ol>
		«FOR s :_self.activity»
		<li>«s.compile()»</li>
		«ENDFOR»
		</ol>'''
	}
}
 
 @Aspect(className=Ble)
class BleAspect extends CultureAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''<h4>blé
		«_self.super_compile»'''
	}	
}

@Aspect(className=Bovin)
class BovinAspect extends ElevageAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''<h4>bovin
		«_self.super_compile»'''
	}	
}

@Aspect(className=Culture)
abstract class CultureAspect extends AtelierAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''(culture) «_self.super_compile»'''
	}	
}

@Aspect(className=Elevage)
abstract class ElevageAspect extends AtelierAspect {

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''(elevage) «_self.super_compile»'''
	}	
}

@Aspect(className=Mais)
class MaisAspect extends CultureAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''<h4>mais
		«_self.super_compile»'''
	}	
}

@Aspect(className=Ovin)
class OvinAspect extends ElevageAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''<h4>ovin
		«_self.super_compile»'''
	}	
}

@Aspect(className=Sorgho)
class SorghoAspect extends CultureAspect{

	def simulate() {
	}

	@OverrideAspectMethod
	def String compile() {
		'''<h4>sorgho
		«_self.super_compile»'''
	}	
}